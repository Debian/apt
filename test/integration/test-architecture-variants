#!/bin/sh
set -e

TESTDIR="$(readlink -f "$(dirname "$0")")"
. "$TESTDIR/framework"
setupenvironment
configarchitecture 'amd64'

msgmsg "Test basic ordering scenarios"

echo 'APT::Architecture-Variants { "amd64v3"; "amd64v2" }' > 'rootdir/etc/apt/apt.conf.d/variants'
insertpackage 'unstable' 'foo' 'amd64:amd64v2' '1'
insertpackage 'unstable' 'foo' 'amd64' '1'
insertpackage 'unstable' 'foo' 'amd64:amd64v3' '1'

setupaptarchive  --no-update

testsuccessequal "" aptget update -qq

testsuccessequal "foo:
  Installed: (none)
  Candidate: 1
  Version table:
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v2 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages" aptcache policy foo
testsuccessequal "'file:${TMPWORKINGDIRECTORY}/aptarchive/pool/main/foo/foo_1_amd64v3.deb' foo_1_amd64v3.deb 42 " apt install --print-uris -qqq foo
echo 'APT::Architecture-Variants { "amd64v2"; "amd64v3" }' > 'rootdir/etc/apt/apt.conf.d/variants'
testsuccessequal "foo:
  Installed: (none)
  Candidate: 1
  Version table:
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v2 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages" aptcache policy foo
testsuccessequal "'file:${TMPWORKINGDIRECTORY}/aptarchive/pool/main/foo/foo_1_amd64v2.deb' foo_1_amd64v2.deb 42 " apt install --print-uris -qqq foo
echo 'APT::Architecture-Variants { "amd64v3" }' > 'rootdir/etc/apt/apt.conf.d/variants'
testsuccessequal "foo:
  Installed: (none)
  Candidate: 1
  Version table:
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages" aptcache policy foo
testsuccessequal "'file:${TMPWORKINGDIRECTORY}/aptarchive/pool/main/foo/foo_1_amd64v3.deb' foo_1_amd64v3.deb 42 " apt install --print-uris -qqq foo


echo 'APT::Architecture-Variants { "amd64v3"; "amd64v2" }' > 'rootdir/etc/apt/apt.conf.d/variants'

msgmsg "Test upgrade calculation: amd64v3 updates to amd64"

insertpackage 'unstable' 'foo' 'amd64' '2'
insertinstalledpackage 'foo' 'amd64:amd64v3' '1'
setupaptarchive  --no-update

testsuccessequal "" aptget update -qq
testsuccessequal "foo:
  Installed: 1
  Candidate: 2
  Version table:
     2 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages
 *** 1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
        100 ${TMPWORKINGDIRECTORY}/rootdir/var/lib/dpkg/status
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v2 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages" aptcache policy foo
testsuccessequal "'file:${TMPWORKINGDIRECTORY}/aptarchive/pool/main/foo/foo_2_amd64.deb' foo_2_amd64.deb 42 " apt dist-upgrade --print-uris -qqq

msgmsg "Test upgrade calculation: amd64v3 updates to amd64v3 now"
insertpackage 'unstable' 'foo' 'amd64:amd64v3' '2'
setupaptarchive  --no-update

testsuccessequal "" aptget update -qq
testsuccessequal "foo:
  Installed: 1
  Candidate: 2
  Version table:
     2 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
     2 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages
 *** 1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v3 Packages
        100 ${TMPWORKINGDIRECTORY}/rootdir/var/lib/dpkg/status
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64v2 Packages
     1 500
        500 file:${TMPWORKINGDIRECTORY}/aptarchive unstable/main amd64 Packages" aptcache policy foo
testsuccessequal "'file:${TMPWORKINGDIRECTORY}/aptarchive/pool/main/foo/foo_2_amd64v3.deb' foo_2_amd64v3.deb 42 " apt dist-upgrade --print-uris -qqq
